// Prisma Database Schema
// Defines all database models for the Isostat basketball statistics platform
//
// Models:
// - Player: Basketball players (can appear in multiple games)
// - Video: YouTube videos containing 1v1 games
// - Game: Individual 1v1 matchups between two players
// - Stat: Detailed basketball statistics for each player in each game
// - Channel: Whitelisted YouTube channels for automated scraping (Phase 1.5)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication and community features
// Uses Supabase Auth for authentication
model User {
  id        String   @id // Supabase Auth UUID
  email     String   @unique
  name      String?
  avatarUrl String?
  isAdmin   Boolean  @default(false)

  // Reputation system (Phase 3 - Labeling)
  reputationScore Int @default(0)
  isTrustedLabeler Boolean @default(false)
  eventsLabeledCount Int @default(0)
  eventsVerifiedCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  submittedVideos Video[] @relation("VideoSubmitter")

  @@index([email])
  @@index([isAdmin])
  @@index([isTrustedLabeler])
}

// Channel model for Phase 1.5 - Whitelisted Channel Scraping
// Tracks YouTube channels approved for automated video scraping
model Channel {
  id               String    @id @default(cuid())
  youtubeChannelId String    @unique // YouTube channel ID (UC...)
  name             String
  description      String?
  thumbnailUrl     String?
  subscriberCount  Int?
  isWhitelisted    Boolean   @default(true)
  scrapeFrequency  String    @default("daily") // daily, weekly, manual
  lastScrapedAt    DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  videos Video[]

  @@index([isWhitelisted])
  @@index([lastScrapedAt])
}

model Player {
  id              String   @id @default(cuid())
  name            String
  aliases         String[] // YouTube name variations
  instagramHandle String?
  height          String? // e.g., "6'2\""
  position        String? // Guard, Forward, etc.
  location        String? // City, State
  imageUrl        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  gamesAsPlayer1 Game[] @relation("Player1")
  gamesAsPlayer2 Game[] @relation("Player2")
  stats          Stat[]

  @@index([name])
}

model Video {
  id           String       @id @default(cuid())
  youtubeId    String       @unique // e.g., "dQw4w9WgXcQ"
  url          String
  title        String
  channelName  String // The Next Chapter, Ballislife, etc.
  thumbnailUrl String?
  uploadedAt   DateTime? // YouTube upload date
  duration     Int? // seconds
  status       VideoStatus @default(PENDING)
  processedAt  DateTime?

  // Submission tracking
  submittedById  String? // Optional: links to User if logged in
  submittedBy    User?   @relation("VideoSubmitter", fields: [submittedById], references: [id], onDelete: SetNull)
  submitterEmail String? // Fallback for anonymous submissions
  submitterNote  String? // Optional context

  // Phase 1.5: Channel scraping fields
  channelId          String? // Links to whitelisted Channel if scraped
  channel            Channel? @relation(fields: [channelId], references: [id], onDelete: SetNull)
  scrapedAt          DateTime? // When this video was auto-scraped
  verificationStatus VerificationStatus @default(UNVERIFIED)

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  game Game?

  @@index([channelName])
  @@index([status])
  @@index([submittedById])
  @@index([channelId])
  @@index([verificationStatus])
}

enum VideoStatus {
  PENDING // Submitted, awaiting processing
  PROCESSING // Currently being analyzed
  COMPLETED // Stats entered/extracted
  FAILED // Processing failed
}

// Phase 1.5: Verification status for data quality tracking
enum VerificationStatus {
  UNVERIFIED // Scraped or submitted, not yet reviewed
  PARTIAL    // Admin viewed but not fully verified
  VERIFIED   // Admin confirmed as valid 1v1 game
}

model Game {
  id           String     @id @default(cuid())
  videoId      String     @unique
  player1Score Int
  player2Score Int
  winnerId     String // player1Id or player2Id
  gameDate     DateTime   @default(now())
  location     String?
  notes        String? // Optional context

  // Phase 1 extensions for roadmap
  rulesetId    String?
  ruleset      Ruleset?   @relation(fields: [rulesetId], references: [id])
  isOfficial   Boolean    @default(false) // Official competitive game vs pickup
  source       GameSource @default(SUBMITTED) // How this game was added
  courtType    CourtType  @default(UNKNOWN)

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  video     Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)
  player1Id String
  player1   Player @relation("Player1", fields: [player1Id], references: [id])
  player2Id String
  player2   Player @relation("Player2", fields: [player2Id], references: [id])

  // Relations
  stats Stat[]

  @@index([player1Id])
  @@index([player2Id])
  @@index([gameDate])
  @@index([videoId])
  @@index([rulesetId])
  @@index([isOfficial])
}

// Ruleset model for Phase 1
// Defines game rules and formats (official 1v1, pickup, etc.)
model Ruleset {
  id             String   @id @default(cuid())
  name           String   @unique // e.g., "Official 1v1 - 30pts"
  description    String?

  // Scoring rules
  scoringTarget  Int      @default(21) // 21, 30, etc.
  shotValues     String   @default("1s-2s") // "1s-2s" or "2s-3s"

  // Game format
  possessionType String   @default("one-possession") // "one-possession" or "make-it-take-it"
  isRefereed     Boolean  @default(false)
  dribbleLimit   Int?     // e.g., 4 dribbles max

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  games Game[]

  @@index([name])
}

// Phase 1: Keep Stat model for backward compatibility
// NOTE: Phase 3 will migrate to event-based stat computation
// This model will be deprecated after event-based tracking is implemented
model Stat {
  id     String @id @default(cuid())
  gameId String
  game   Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)

  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  // Basketball stats
  points                 Int @default(0)
  fieldGoalsMade         Int @default(0)
  fieldGoalsAttempted    Int @default(0)
  threePointersMade      Int @default(0)
  threePointersAttempted Int @default(0)
  freeThrowsMade         Int @default(0)
  freeThrowsAttempted    Int @default(0)
  rebounds               Int @default(0)
  assists                Int @default(0)
  steals                 Int @default(0)
  blocks                 Int @default(0)
  turnovers              Int @default(0)
  fouls                  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gameId, playerId])
  @@index([playerId])
  @@index([gameId])
}

// Enums
enum GameSource {
  SUBMITTED // User-submitted
  SCRAPED   // Auto-scraped from YouTube (Phase 1.5)
}

enum CourtType {
  INDOOR
  OUTDOOR
  UNKNOWN
}
