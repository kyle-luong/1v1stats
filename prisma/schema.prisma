// Prisma Database Schema
// Defines all database models for the 1v1stats basketball statistics platform
//
// Models:
// - Player: Basketball players (can appear in multiple games)
// - Channel: Whitelisted YouTube channels for scraping (Phase 1.5)
// - Video: YouTube videos with category and approval workflow
// - Game: Individual 1v1 matchups between two players
// - Stat: Detailed basketball statistics for each player in each game

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication and community features
// Uses Supabase Auth for authentication
model User {
  id        String   @id // Supabase Auth UUID
  email     String   @unique
  name      String?
  avatarUrl String?
  isAdmin   Boolean  @default(false)

  // Reputation system (Phase 3 - Labeling)
  reputationScore Int @default(0)
  isTrustedLabeler Boolean @default(false)
  eventsLabeledCount Int @default(0)
  eventsVerifiedCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  submittedVideos Video[] @relation("VideoSubmitter")

  @@index([email])
  @@index([isAdmin])
  @@index([isTrustedLabeler])
}

// Channel model for Phase 1.5 - Whitelisted Channel Scraping
// Tracks YouTube channels approved for automated video scraping
model Channel {
  id               String    @id @default(cuid())
  youtubeChannelId String    @unique // YouTube channel ID (UC...)
  name             String
  description      String?
  thumbnailUrl     String?
  subscriberCount  Int?
  isActive         Boolean   @default(true) // Whether to include in scraping
  scrapeFrequency  String    @default("daily") // "daily" or "manual"
  lastScrapedAt    DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  videos Video[]

  @@index([isActive])
  @@index([lastScrapedAt])
}

model Player {
  id              String   @id @default(cuid())
  name            String   // Display name (what they go by)
  fullName        String?  // Full legal name
  aliases         String[] // Other names used in videos
  bio             String?  // Player description/bio
  
  // Physical info
  height          String?  // e.g., "6'2\""
  weight          String?  // e.g., "185 lbs"
  
  // Location
  hometown        String?  // Where they're from originally
  location        String?  // Current city/state
  
  // Personal
  birthDate       DateTime? // Date of birth
  imageUrl        String?
  
  // Social links
  instagramHandle String?
  twitterHandle   String?
  youtubeChannel  String?
  tiktokHandle    String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  gamesAsPlayer1 Game[] @relation("Player1")
  gamesAsPlayer2 Game[] @relation("Player2")
  stats          Stat[]
  feedback       Feedback[]

  @@index([name])
}

model Video {
  id           String        @id @default(cuid())
  youtubeId    String        @unique // e.g., "dQw4w9WgXcQ"
  url          String
  title        String
  channelName  String        // The Next Chapter, Ballislife, etc.
  thumbnailUrl String?
  uploadedAt   DateTime?     // YouTube upload date
  duration     Int?          // seconds
  status       VideoStatus   @default(SCRAPED)
  category     VideoCategory @default(UNCATEGORIZED)
  isCompetitive Boolean      @default(false) // Only competitive 1v1s affect player stats
  processedAt  DateTime?

  // Channel scraping (Phase 1.5)
  channelId    String?       // Links to whitelisted Channel if scraped
  channel      Channel?      @relation(fields: [channelId], references: [id], onDelete: SetNull)
  scrapedAt    DateTime?     // When this video was auto-scraped

  // Submission tracking
  submittedById  String?     // Optional: links to User if logged in
  submittedBy    User?       @relation("VideoSubmitter", fields: [submittedById], references: [id], onDelete: SetNull)
  submitterEmail String?     // Fallback for anonymous submissions
  submitterNote  String?     // Optional context

  // Submitted game info (unverified, from submitter)
  // These are required on submission but stored here until admin approves
  submittedPlayer1Name  String?
  submittedPlayer2Name  String?
  submittedPlayer1Score Int?
  submittedPlayer2Score Int?
  submittedCategory     VideoCategory? // User-suggested category (for SCRAPED videos)
  submittedIsCompetitive Boolean?       // User-suggested competitive flag

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  game Game?
  feedback Feedback[]

  @@index([channelName])
  @@index([status])
  @@index([category])
  @@index([channelId])
  @@index([submittedById])
}

// Video approval workflow status
enum VideoStatus {
  SCRAPED  // Auto-discovered from channel, visible but uncategorized
  PENDING  // User submitted data, awaiting admin approval
  APPROVED // Admin approved, categorized (Game created if 1v1)
  REJECTED // Not suitable for platform
}

// Video content category
enum VideoCategory {
  UNCATEGORIZED  // Not yet reviewed
  ONE_V_ONE      // Official 1v1 (requires Game record)
  SPAR           // Practice/spar 1v1
  TWO_V_TWO      // 2v2 games
  THREE_V_THREE  // 3v3 games
  FIVE_V_FIVE    // 5v5 games
  TAG_TEAM       // Tag team matches
  REACTION       // Reaction/commentary videos
  MISC           // Other content
}

model Game {
  id           String     @id @default(cuid())
  videoId      String     @unique
  player1Score Int
  player2Score Int
  winnerId     String // player1Id or player2Id
  gameDate     DateTime   @default(now())
  location     String?
  notes        String? // Optional context

  // Phase 1 extensions for roadmap
  rulesetId    String?
  ruleset      Ruleset?   @relation(fields: [rulesetId], references: [id])
  isOfficial   Boolean    @default(false) // Official competitive game vs pickup
  source       GameSource @default(SUBMITTED) // How this game was added
  courtType    CourtType  @default(UNKNOWN)

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  video     Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)
  player1Id String
  player1   Player @relation("Player1", fields: [player1Id], references: [id])
  player2Id String
  player2   Player @relation("Player2", fields: [player2Id], references: [id])

  // Relations
  stats Stat[]
  feedback Feedback[]

  @@index([player1Id])
  @@index([player2Id])
  @@index([gameDate])
  @@index([videoId])
  @@index([rulesetId])
  @@index([isOfficial])
}

// Ruleset model for Phase 1
// Defines game rules and formats (official 1v1, pickup, etc.)
model Ruleset {
  id             String   @id @default(cuid())
  name           String   @unique // e.g., "Official 1v1 - 30pts"
  description    String?

  // Scoring rules
  scoringTarget  Int      @default(30) // 21, 30, etc.
  shotValues     String   @default("1s-2s") // "1s-2s" or "2s-3s"

  // Game format
  possessionType String   @default("one-possession") // "one-possession" or "make-it-take-it"
  isRefereed     Boolean  @default(false)
  dribbleLimit   Int?     // e.g., 4 dribbles max

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  games Game[]

  @@index([name])
}

// Phase 1: Keep Stat model for backward compatibility
// NOTE: Phase 3 will migrate to event-based stat computation
// This model will be deprecated after event-based tracking is implemented
model Stat {
  id     String @id @default(cuid())
  gameId String
  game   Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)

  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  // Basketball stats
  points                 Int @default(0)
  fieldGoalsMade         Int @default(0)
  fieldGoalsAttempted    Int @default(0)
  threePointersMade      Int @default(0)
  threePointersAttempted Int @default(0)
  freeThrowsMade         Int @default(0)
  freeThrowsAttempted    Int @default(0)
  rebounds               Int @default(0)
  assists                Int @default(0)
  steals                 Int @default(0)
  blocks                 Int @default(0)
  turnovers              Int @default(0)
  fouls                  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gameId, playerId])
  @@index([playerId])
  @@index([gameId])
}

// Site-wide statistics for tracking visits
model SiteStats {
  id        String   @id @default("singleton")
  visits    Int      @default(0)
  updatedAt DateTime @updatedAt
}

// Enums
enum GameSource {
  SUBMITTED // User-submitted
  SCRAPED   // Auto-scraped from YouTube (Phase 1.5)
}

enum CourtType {
  INDOOR
  OUTDOOR
  UNKNOWN
}

// Feedback model for bug reports, feature requests, and data corrections
model Feedback {
  id          String         @id @default(cuid())
  type        FeedbackType
  status      FeedbackStatus @default(UNREVIEWED)
  
  // Content
  title       String
  description String         @db.Text
  
  // Contact info (optional)
  email       String?
  name        String?
  
  // Metadata
  submittedAt DateTime       @default(now())
  reviewedAt  DateTime?
  reviewedBy  String?        // User ID of admin who reviewed
  adminNotes  String?        @db.Text
  
  // Relations - for data corrections to link to specific content
  relatedVideoId  String?
  relatedVideo    Video?   @relation(fields: [relatedVideoId], references: [id], onDelete: SetNull)
  relatedPlayerId String?
  relatedPlayer   Player?  @relation(fields: [relatedPlayerId], references: [id], onDelete: SetNull)
  relatedGameId   String?
  relatedGame     Game?    @relation(fields: [relatedGameId], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([status])
  @@index([type])
  @@index([submittedAt])
  @@map("feedback")
}

enum FeedbackType {
  BUG_REPORT
  FEATURE_REQUEST
  DATA_CORRECTION
  GENERAL
}

enum FeedbackStatus {
  UNREVIEWED
  RESOLVED
  CLOSED
}
